---
title: "Batch Correction"
author: "ALSF CCDL - Candace Savonen"
output:   
  html_notebook: 
    toc: true
    toc_float: true
---

*Purpose*: This notebook illustrates how to assess batch effects and how to use
`limma` to batch correct. 

The [refine.bio normalization pipeline]( http://docs.refine.bio/en/latest/main_text.html)
completed prior to your download, may be sufficient for removing batch effects
for many datasets. 
It is good practice to assess for batch effects regardless, especially if your 
dataset consists of more than one type of platform. 

In this example, we will use expression data collected from Acute Myeloid 
Leukemia patients. 

This aggregated dataset consists of four original datasets we aggregated by 
species on refine.bio.

GSE6891
GSE14468
SRP048759
SRP033266

Two of these datasets are RNA-seq data and the other two are measured on a
hgu133plus2 microarray. 

## 1) Set up
This will install `limma` for you if you haven't installed it before. 
We recommend looking through [`limma`'s guide](https://bioconductor.org/packages/release/bioc/vignettes/limma/inst/doc/usersguide.pdf)
for further information. 

```{r}
if (!("limma" %in% installed.packages())) {
  # Install limma
  BiocManager::install("limma", update = FALSE)
}
```

```{r}
# Magrittr pipe
`%>%` <- dplyr::`%>%`

# Load ggplot2 for graphing
library(ggplot2)
```

```{r}
# Make a results directory if it isn't created yet
if (!dir.exists("results")) {
  dir.create("results")
}
# Make a plots directory if it isn't created yet
if (!dir.exists("plots")) {
  dir.create("plots")
}
```

## 2) Import and set up data
Data downloaded from refine.bio include a metadata tab separated values ("tsv")
file and a data tsv file. 
These files were obtained from [refine.bio](https://www.refine.bio/) by entering
the search term "AML" and then aggregating by `species`.

```{r Import refine.bio data}
# Put name of data file
data.filename <- file.path( "data", "HOMO_SAPIENS.tsv")

# Unzip the file and direct it to the data folder
unzip(paste0(data.filename, ".zip"), exdir = "data")

# Read in data tsv file
df <- readr::read_tsv(data.filename, progress = FALSE) %>%
  tibble::column_to_rownames('Gene')
# Make the gene column the rownames so the gene names are out of the way for calculations
```

Prep metadata to be in proper format for batch info to be used by ComBat

```{r Prep metadata}
# Metadata file name
metadata.filename <- file.path("data", "metadata_HOMO_SAPIENS.tsv")

# Read in data tsv file
metadata <- readr::read_tsv(metadata.filename, progress = FALSE)

# Put samples in the same order in the dataframe
df <- df %>% dplyr::select(metadata$refinebio_accession_code)

# Check if the samples are in the same order
all.equal(metadata$refinebio_accession_code, colnames(df))
```

## 3) Set up batch information. 
For this batch correction, we will want both original dataset information as 
well as platform information. 

Set up the platform information. 

```{r}
# Get rid of spaces to streamline things 
metadata$refinebio_platform <- gsub(" ", "", metadata$refinebio_platform)

# Make into a factor
platform <- as.factor(metadata$refinebio_platform)
```

Set up the dataset of origin information.

```{r}
# Make a dataset vector
dataset <- metadata$series_id

# Fill in the NA's for the dataset that isn't included in this variable
dataset[is.na(dataset)] <- "SRP048759"

# Make this a factor
dataset <- as.factor(dataset)
```

## 4) Perform Principal Components Analysis

```{r}
# Calculate PCA
pca <- prcomp(t(df))

# Make into dataframe for plotting with ggplot2
pca.df <- data.frame(pca$x[, 1:2])
```

Plot these PC scores and look for how samples of different platforms and 
datasets cluster. 

```{r}
# Create a scatterplot
pc.plot <- ggplot(pca.df, 
                  aes(x = PC1, y = PC2, color = dataset, shape = platform)) +
  geom_point() + 
  ggtitle("Uncorrected") +
  theme_classic()

# Print out the plot here
pc.plot
```

In this example dataset, we notice this "batch effect" is actually mostly a 
difference in platform. 
The group of samples on the left come from different datasets but are all 
hgu133plus2 microarray data. 
The group of the samples on the 

Save plot to a png.

```{r}
# Save the plot to a png
ggsave(file.path("plots", "uncorrected_pc_plot.png"))
```

## 5) Peform ComBat correction
To run ComBat, we need batch information, in this case we will use the dataset
ids.

```{r}
# Use removeBatchEffect function from limma
corrected.df <- limma::removeBatchEffect(df, batch =  platform, batch2 = dataset)
```

## 6) Re-evaluate PCA after batch correction
Let's see if batch correction helped with making PC scores less divided by batches. 

```{r}
# Calculate PCA
corrected.pca <- prcomp(t(corrected.df))

# Make into dataframe for plotting with ggplot2
corrected.pca.df <- data.frame(corrected.pca$x[, 1:2])
```

Plot these batch corrected data PC scores.

```{r}
# Create a scatterplot, same as before, but with the corrected data
pc.plot <- ggplot(corrected.pca.df, 
                  aes(x = PC1, y = PC2, color = dataset, shape = platform)) +
  geom_point() + 
  ggtitle("Batch corrected") +
  theme_classic()

# Print out the plot here
pc.plot
```

Although the correction doesn't completely get rid of the batch effects on PC2, It clearly reduces the effect of the batch effect on PC1. 
This an example of how batch correction can help, but will probably not get rid of the problem entirely. 
Depending on what analyses these data were being used for, we would consider 
analyzing these datasets separately, or moving forward with only samples of one 
platform type. 

Save plot with batch corrected PCA plot to a png.

```{r}
ggsave(file.path("plots", "batch_corrected_pca_plot.png"))
```

## 7) Save batch corrected data to tsv file

We will save the batch corrected dataframe to a tsv file for hypothetical future
use. 

```{r}
corrected.df %>% as.data.frame() %>% 
  tibble::rownames_to_column("Gene") %>%
  readr::write_tsv(file.path("results", "batch_corrected_exprs.tsv"))
```

Session info: 

```{r Print session info}
# Print session info 
sessionInfo()
```
