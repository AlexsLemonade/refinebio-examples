---
title: "Batch Correction"
author: "ALSF CCDL - Candace Savonen"
output:   
  html_notebook: 
    toc: true
    toc_float: true
---

*Purpose*: This notebook illustrates how to assess batch effects and how to use
`limma` to batch correct. 

## 1) Set up
This will install `limma` for you if you haven't installed it before. 
We recommend using [`limma`'s guide on](https://bioconductor.org/packages/release/bioc/vignettes/limma/inst/doc/usersguide.pdf).

```{r}
if (!("limma" %in% installed.packages())) {
  # Install limma
  BiocManager::install("limma", update = FALSE)
}
```

```{r}
# Make a results directory if it isn't created yet
if (!dir.exists("results")) {
  dir.create("results")
}
# Make a plots directory if it isn't created yet
if (!dir.exists("plots")) {
  dir.create("plots")
}
```

```{r}
# Magrittr pipe
`%>%` <- dplyr::`%>%`

# Load ggplot2 for graphing
library(ggplot2)
```

## 2) Import and set up data
Data downloaded from refine.bio include a metadata tab separated values ("tsv")
file and a data tsv file. 
These files were obtained from [refine.bio](https://www.refine.bio/) by entering
the search term "TODO" and then aggregating by `species`.

```{r Import refine.bio data}
# Put name of data file
data.filename <- file.path( "data", "HOMO_SAPIENS.tsv")

# Unzip the file and direct it to the data folder
#unzip(paste0(data.filename, ".zip"), exdir = "data")

# Read in data tsv file
df <- readr::read_tsv(data.filename, progress = FALSE) %>% 
  tibble::column_to_rownames('Gene') 
# Make the gene column the rownames so the gene names are out of the way for calculations
```

Prep metadata to be in proper format for batch info to be used by ComBat

```{r Prep metadata}
# Metadata file name
metadata.filename <- file.path("data", "metadata_HOMO_SAPIENS.tsv")

# Read in data tsv file
metadata <- readr::read_tsv(metadata.filename, progress = FALSE)

# Get rid of spaces to streamline things 
metadata$refinebio_platform <- gsub(" ", "", metadata$refinebio_platform)

# Put samples in the same order in the dataframe
df <- df[, metadata$refinebio_accession_code]

# Check if the samples are in the same order
all.equal(metadata$refinebio_accession_code, colnames(df))
```

## 3) Perform Principal Components Analysis

```{r}
# Calculate PCA
pca <- prcomp(t(df))

# Make into dataframe for plotting with ggplot2
pca.df <- data.frame(pca$x[, 1:2])
```

Plot these PC scores.
We will likely see a difference between the datasets.

```{r}
pc.plot <- ggplot(pca.df, aes(x = PC1, y = PC2, 
                              color = metadata$refinebio_platform)) +
  geom_point() + 
  ggtitle("Non-batch corrected")

# Print out the plot here
pc.plot
```

Save plot to a png.

```{r}
# Save the plot to a png
ggsave(file.path("plots", "uncorrected_pc_plot.png"))
```

## 4) Peform ComBat correction
To run ComBat, we need batch information, in this case we will use the dataset
ids.

```{r}
corrected.df <- limma::removeBatchEffect(df, 
                                         batch =  as.factor(metadata$refinebio_platform))
```

## 5) Re-evaluate PCA after batch correction
Let's see if batch correction helped with making PC scores less divided by batches. 

```{r}
# Calculate PCA
corrected.pca <- prcomp(t(corrected.df))

# Make into dataframe for plotting with ggplot2
corrected.pca.df <- data.frame(corrected.pca$x[, 1:2], 
                               dataset = metadata$refinebio_platform)
```

Plot these batch corrected data PC scores.

```{r}
pc.plot <- ggplot(corrected.pca.df, aes(x = PC1, y = PC2, 
                                        color = metadata$refinebio_platform)) +
  geom_point() + 
  ggtitle("Batch corrected")

# Print out the plot here
pc.plot
```

Save plot with batch corrected PCA plot to a png.

```{r}
ggsave(file.path("plots", "batch_corrected_pca_plot.png"))
```

## 6) Save batch corrected data to tsv file

```{r}
corrected.df %>% as.data.frame() %>% 
  tibble::rownames_to_column("Gene") %>%
  readr::write_tsv(file.path("results", "batch_corrected_exprs.tsv"))
```

Session info: 

```{r Print session info}
# Print session info 
sessionInfo()
```
