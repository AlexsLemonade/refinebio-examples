---
title: "UMAP Visualization"
author: "ALSF CCDL - Candace Savonen"
output:   
  html_notebook: 
    toc: true
    toc_float: true
---

*Purpose*: This notebook illustrates how to perform Uniform Manifold Approximation
and plot the coordinates using ggplot2. 

UMAP does require more dimensions than PCA, though, so if you have a smaller 
dataset (less than 20) and you obtain errors, you may not be able to run UMAP 
for your dataset.

Recommended articles on UMAP:   
- [How UMAP works with visuals](https://umap-learn.readthedocs.io/en/latest/how_umap_works.html)  
- [Original paper on UMAP](https://arxiv.org/abs/1802.03426) by McGinnes, Healy & Melville.  

## 1) Set up
Install [`umap` R package](https://cran.r-project.org/web/packages/umap/vignettes/umap.html) 
if you have not installed it previously. 

```{r}
# Install umap if it isn't in the list of installed packages
if (!("umap" %in% installed.packages())) {
  install.packages("umap")
}
```

```{r}
# Set seed
set.seed(12345)

# Magrittr pipe
`%>%` <- dplyr::`%>%`

# Load ggplot2 for graphing
library(ggplot2)
```

Set up output directories.

```{r}
# Define the file path to the results directory
results_dir <- "results"  # Replace with path to desired output results directory

# Make a results directory if it isn't created yet
if (!dir.exists(results_dir)) {
  dir.create(results_dir)
}

# Define the file path to the plots directory
plots_dir <- "plots"  # Replace with path to desired output plots directory

# Make a plots directory if it isn't created yet
if (!dir.exists(plots_dir)) {
  dir.create(plots_dir)
}
```

## 2) Import and set up data.
Data downloaded from refine.bio are in tab separated values ("tsv") files and 
include a metadata in a separate tsv file. 
These data set was obtained from [refine.bio](https://www.refine.bio/). 

```{r}
# Put name of data file
data.filename <- file.path("data", # Replace with path to your data file
                           "GSE37382.tsv") # Replace with the name of your data file

# Unzip the file and direct it to the data folder
unzip(paste0(data.filename, ".zip"),
      exdir = "data" # Replace with path to your data file
      )

# Read in data tsv file
df <- readr::read_tsv(data.filename, progress = FALSE) %>% 
  # Make the gene column the rownames so the gene names are out of the way for calculations
  tibble::column_to_rownames('Gene') 
```

Import the metadata for this dataset

```{r}
# Metadata file name
metadata.filename <- file.path("data", # Replace with path to your metadata file
                               "metadata_GSE37382.tsv" # Replace with the name of your metadata file
                               ) 

# Read in metadata tsv file
metadata <- readr::read_tsv(metadata.filename) %>% 
  # Get rid of columns that have only NAs
  dplyr::select(-which(apply(is.na(.), 2, all)))

# Print out metadata so we can get an idea of what we have
metadata
```

## 3) Perform Uniform Manifold Approximation.

```{r}
# Calculate umap
umap.dat <- umap::umap(t(df))

# Make into dataframe 
umap.df <- data.frame(umap.dat$layout) %>% 
  # Turn samples_ids stored as rownames into column
  tibble::rownames_to_column("refinebio_accession_code") %>%
  # Bring the metadata into this df; match by sample ids
  dplyr::inner_join(dplyr::select(metadata, refinebio_accession_code, 
                                  histology, subgroup), 
                    by = 'refinebio_accession_code')
```

Plot the UMAP coordinates.
Label the data points based on their subgroup.

```{r}
# Make a scatterplot with ggplot2
umap.plot <- ggplot(umap.df, aes(x = X1, y = X2, color = subgroup)) +
  geom_point() + 
  theme_classic()

# Print out plot here
umap.plot
```

## 4) Save plot to png.

```{r}
# Save as a png
ggsave(file.path(plots_dir,
                 "GSE37382_umap_scatterplot.png" # Replace with a relevant output plot name
                 ))
```

## 5) Save UMAP coordinates to tsv file.

```{r}
umap.df %>% as.data.frame() %>% 
  readr::write_tsv(file.path(results_dir,
                             "GSE37382_umap_scores.tsv" # Replace with a relevant output name
                             ))
```

Session info: 

```{r}
# Print session info 
sessionInfo()
```
