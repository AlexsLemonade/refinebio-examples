---
title: "Differential Expression Analysis for GSE37382"
author: "ALSF CCDL - Candace Savonen"
output:   
  html_notebook: 
    toc: true
    toc_float: true
---

*Purpose*: This notebook tests differential expression in probe data from 
author-submitted version of GSE37382, a medulloblastoma microarray dataset. 

The results from this differential expression analysis is used in the following
notebook to compare how the processing of this microarray data affects 
differential expression outcomes.
The data here are medulloblastoma microarray data produced by [Northcott et al, 2012](https://www.ncbi.nlm.nih.gov/pubmed/22832581) and are obtained from Gene 
Expression Omnibus (GEO).

## 1) Install libraries
This script uses the bioconductor R package limma to identify differentially 
expressed genes.  
The full guide on [limma](https://bioconductor.org/packages/release/bioc/vignettes/limma/inst/doc/usersguide.pdf) 
shows examples of limma functions.  
We will also use the library `GEOquery` to obtain the author-processed data. 

```{r Install limma}
if (!("limma" %in% installed.packages())) {
  # Install limma
  BiocManager::install("limma", update = FALSE)
}
if (!("GEOquery" %in% installed.packages())) {
  # Install GEOquery
  BiocManager::install("GEOquery", update = FALSE)
}
```

Attach the `limma` library:

```{r}
# Magrittr pipe
`%>%` <- dplyr::`%>%`

# Attach library
library(limma)
```

Set up output directories.

```{r}
# Make a results directory if it isn't created yet
if (!dir.exists("results")) {
  dir.create("results")
}
# Make a plots directory if it isn't created yet
if (!dir.exists("plots")) {
  dir.create("plots")
}
# Make a data directory if it isn't created yet
if (!dir.exists("data")) {
  dir.create("data")
}
```

## 2) Import and set up author processed data from GEO
For more information on how this data was processed, see its 
[GEO entry](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE37382)

```{r}
# Store file name for gene matrix
matrix.file.name <- file.path("data", "GSE37382_series_matrix.txt")

# Download author processed data file directly to `data` folder
geo.data <-  GEOquery::getGEO("GSE37382", destdir = "data", GSEMatrix = TRUE)
  
# If the unzipped version of the file doesn't exist, run this
if (!file.exists(matrix.file.name)) {
  # Unzip the .gz file with the gene matrix in it
  GEOquery::gunzip(paste0(matrix.file.name, ".gz"))
}
```

Read in the gene matrix.

```{r}
# Read in the author processed gene matrix
author.df <- readr::read_tsv(file.path("data", "GSE37382_series_matrix.txt"), 
                             comment = "!") %>% 
  # Store probe ids as the rownames
  tibble::column_to_rownames("ID_REF")
```

## 3) Extract metadata for this dataset

```{r}
# Extract metadata
metadata <- data.frame(geo.data[[1]]@phenoData@data) %>% 
  # Get rid of columns that have only NAs
  dplyr::select(-which(apply(is.na(.), 2, all))) %>% 
  readr::write_tsv(file.path("data", "geo_obtained_GSE37382_metadata.tsv"))

# Double check if metadata and data are in same order
all.equal(metadata$geo_accession, colnames(author.df))

# Print out metadata so we can get an idea of what we have
metadata
```

## 4) Set up design matrix
limma needs a numeric design matrix to signify which are treatment and control
samples. 

```{r Set up design matrix}
# Set up group names 
group <- as.factor(gsub(" ", "", metadata$subgroup.ch1))

# Create the design matrix
des.mat <- model.matrix( ~ 0 + group)

# Change names of columns in design matrix to match
colnames(des.mat) <- levels(group)
```

## 5) Apply linear model
After applying our data to linear model, in this example we apply empirical Bayes
smoothing and Benjamini-Hochberg multiple testing correction. 

```{r Apply linear model}
# Initial fit
fit <- limma::lmFit(author.df, des.mat)

# Make contrasts
cont.matrix <- makeContrasts(
  SHHvsGroup3 = SHH-Group3,
  Group3vsGroup4 = Group3-Group4,
  Group4vsSHH = Group4-SHH,
  levels = des.mat)

# Apply linear model to data
fit2 <- lmFit(author.df, design = des.mat)

# Apply empirical Bayes to smooth standard errors
fit2 <- contrasts.fit(fit2, cont.matrix)
fit2 <- eBayes(fit2)
```

Obtain summary statistics:

```{r}
# Apply multiple testing correction and obtain stats
stats <- topTable(fit2, number = nrow(author.df)) %>% 
  tibble::rownames_to_column("affy_probe_ids")

# Print out stats
stats
```

## 6) Write statistics to output results file

```{r  Write results}
# Save summary statistics to a tsv file
readr::write_tsv(stats, file.path("results", "GSE37382_limma_results.tsv"))

# Save the limma fit object to an RDS for later use
saveRDS(fit2, file.path("results", "GSE37382_limma_fit_obj.RDS"))
```

Print session info:

```{r}
sessionInfo()
```
