---
title: "Batch Correction"
author: "ALSF CCDL - Candace Savonen"
date: 4/3/2019
output: html_document
---

*Purpose*: This notebook illustrates how to assess batch effects and how to use
comBat to correct for them. 

## 1) Upload ComBat function
Johnson, WE, Rabinovic, A, and Li, C (2007). Adjusting batch effects in microarray expression data using Empirical Bayes methods. Biostatistics 8(1):118-127.

```{r Upload ComBat functions}
# Magrittr pipe
`%>%` <- dplyr::`%>%`

# Load ggplot2 for graphing
library(ggplot2)

# Download ComBat functions
download.file("https://www.bu.edu/jlab/wp-assets/ComBat/Download_files/ComBat.R", 
         destfile = file.path("..", "scripts", "ComBat.R"))

# Load in the ComBat functions
source(file.path("..", "scripts", "ComBat.R"))
```

## 2) Import and set up data
Data downloaded from refine.bio include a metadata tab separated values ("tsv")
file and a data tsv file. This chunk of code will read the both tsv files and 
add them as data.frames to your environment.

```{r Import refine.bio data}
# Put name of data file
data.filename <- file.path("..", "data", "aggregated_MUS_MUSCULUS.tsv")

# Read in data tsv file
df <- readr::read_tsv(data.filename) %>% 
  tibble::column_to_rownames('X1') 
# Make the gene column the rownames so the gene names are out of the way for calculations
```

Prep metadata to be in proper format for batch info to be used by ComBat

```{r Prep metadata}
# Use sample names to create a dataset label vector 
dataset <- as.factor(stringr::word(colnames(df), sep = "-", 3))
```

## 3) Perform Principal Components Analysis

```{r Choose genes}
# Calculate PCA
pca <- prcomp(t(df))

# Make into dataframe for plotting with ggplot2
pca.df <- data.frame(pca$x[, 1:2], 
                     dataset)
```

Plot these PC scores.
We will likely see a difference between the datasets.

```{r}
ggplot(pca.df, aes(x = PC1, y = PC2, color = dataset)) +
  geom_point() + 
  ggtitle("Non-batch corrected")
```

## 4) Peform ComBat correction
To run ComBat, we need a sample information file. 
For more details on ComBat usage see [the documentation.](https://www.bu.edu/jlab/wp-assets/ComBat/Usage.html) 

```{r Create sample info file}
# Create file name and path for sample info file
sample.info.file <- file.path("sample_info.txt")

# Make data frame with sample info
sample.info <- data.frame(Array = colnames(df), Sample = colnames(df), 
                          Batch = levels(dataset))

# Write to txt file
readr::write_tsv(sample.info, sample.info.file)
```

Using the sample info we created, we will use `ComBat` to correct for batch.
Here we are using `skip = 1` so that `ComBat` will ignore the gene column.

```{r ComBat correction}
corrected.df <- ComBat(data.filename, sample.info.file, skip = 1, write = FALSE)
```

## 5) Re-evaluate PCA after batch correction
Let's see if ComBat helped with making PC scores less divided by batches. 

```{r Choose genes}
# Calculate PCA
corrected.pca <- prcomp(t(corrected.df))

# Make into dataframe for plotting with ggplot2
corrected.pca.df <- data.frame(corrected.pca$x[, 1:2], 
                     dataset)
```

Plot these batch corrected data PC scores.

```{r}
ggplot(corrected.pca.df, aes(x = PC1, y = PC2, color = dataset)) +
  geom_point() + 
  ggtitle("Non-batch corrected")
```

Session info: 

```{r Print session info}
# Print session info 
sessionInfo()
```
