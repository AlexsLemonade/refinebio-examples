---
title: "Batch Correction"
author: "ALSF CCDL - Candace Savonen"
output:   
  html_notebook: 
    toc: true
    toc_float: true
---

*Purpose*: This notebook illustrates how to assess batch effects and how to use
ComBat to correct for them. 

## 1) Set up libraries
Johnson, WE, Rabinovic, A, and Li, C (2007). Adjusting batch effects in microarray expression data using Empirical Bayes methods. Biostatistics 8(1):118-127.

```{r Upload ComBat functions}
# Magrittr pipe
`%>%` <- dplyr::`%>%`

# Load ggplot2 for graphing
library(ggplot2)
```

## 2) Import and set up data
Data downloaded from refine.bio include a metadata tab separated values ("tsv")
file and a data tsv file. This chunk of code will read the both tsv files and 
add them as data.frames to your environment.

```{r Import refine.bio data}
# Put name of data file
data.filename <- file.path("..", "data", "DANIO_RERIO.tsv")

# Read in data tsv file
df <- readr::read_tsv(data.filename) %>% 
  tibble::column_to_rownames('X1') 
# Make the gene column the rownames so the gene names are out of the way for calculations
```

Prep metadata to be in proper format for batch info to be used by ComBat

```{r Prep metadata}
# Metadata file name
metadata.filename <- file.path("..", "data", "metadata_DANIO_RERIO.tsv")

# Read in data tsv file
metadata <- readr::read_tsv(metadata.filename)

# dataset <- as.factor(stringr::word(colnames(df), sep = ":", 1))
df <- df[, metadata$refinebio_accession_code]

# Check if the samples are in the same order
all.equal(metadata$refinebio_accession_code, colnames(df))

# Change metadata NA's to be the controls as well
metadata$protocol[is.na(metadata$protocol)] <- "not amputated"

# Only keep these in the data and metadata
metadata <- metadata[hek293, ]
df <- as.matrix(df[, hek293])

# Take a look at the information we have for these data
metadata
```

## 3) Perform Principal Components Analysis

```{r}
# Calculate PCA
pca <- prcomp(t(df))

# Make into dataframe for plotting with ggplot2
pca.df <- data.frame(pca$x[, 1:2], 
                     dataset = metadata$series_id)
```

Plot these PC scores.
We will likely see a difference between the datasets.

```{r}
ggplot(pca.df, aes(x = PC1, y = PC2, color = dataset)) +
  geom_point() + 
  ggtitle("Non-batch corrected")
```

## 4) Peform ComBat correction
To run ComBat, we need a sample information file. 
For more details on ComBat

```{r ComBat correction}
corrected.df <- sva::ComBat(as.matrix(df), metadata$series_id)
```

## 5) Re-evaluate PCA after batch correction
Let's see if ComBat helped with making PC scores less divided by batches. 

```{r}
# Calculate PCA
corrected.pca <- prcomp(t(corrected.df))

# Make into dataframe for plotting with ggplot2
corrected.pca.df <- data.frame(corrected.pca$x[, 1:2], 
                               dataset = metadata$series_id)
```

Plot these batch corrected data PC scores.

```{r}
ggplot(corrected.pca.df, aes(x = PC1, y = PC2, color = dataset)) +
  geom_point() + 
  ggtitle("Batch corrected")
```

Session info: 

```{r Print session info}
# Print session info 
sessionInfo()
```
