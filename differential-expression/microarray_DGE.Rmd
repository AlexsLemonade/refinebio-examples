---
title: "Differential Expression Analysis: Microarray"
author: "ALSF CCDL - Candace Savonen"
output:   
  html_notebook: 
    toc: true
    toc_float: true
---

*Purpose*: This notebook takes data and metadata from refine.bio and identifies 
differentially expressed genes. 
This script is generally applicable to microarray data.

## 1) Install libraries
This script uses the bioconductor R package limma to identify differentially 
expressed genes.  
The full guide on [limma](https://bioconductor.org/packages/release/bioc/vignettes/limma/inst/doc/usersguide.pdf) 
shows examples of limma functions. 
<i>Citation</i>: Ritchie ME, Phipson B, Wu D, Hu Y, Law CW, Shi W, Smyth GK (2015). 
“limma powers differential expression analyses for RNA-sequencing and microarray
studies.” Nucleic Acids Research, 43(7), e47. 

```{r Install limma}
if (!("limma" %in% installed.packages())) {
  # Install limma
  BiocManager::install("limma", update = FALSE)
}
```

Attach the `limma` library:

```{r}
# Magrittr pipe
`%>%` <- dplyr::`%>%`

# Attach library
library(limma)
```

Create output folders.

```{r}
# Create the results folder if it doesn't exist
if (!dir.exists("results")) { # Replace with path to desired output results directory
  dir.create("results") # Replace with path to desired output results directory
}
# Create the plots folder if it doesn't exist
if (!dir.exists("plots")) { # Replace with path to desired output plots directory
  dir.create("plots") # Replace with path to desired output plots directory
}
```

## 2) Import and set up data
Data downloaded from refine.bio include a metadata tab separated values ("tsv")
file and a data tsv file. This chunk of code will read the both tsv files and 
add them as data.frames to your environment. 

```{r Import data from .tsv files}
# Read in metadata tsv file
metadata <- readr::read_tsv(file.path("data", # Replace with path to your metadata file
                                      "metadata_GSE71270.tsv")) # Replace with the name of your metadata file

# Read in data tsv file
df <- readr::read_tsv(file.path("data", # Replace with path to your data file
                                "GSE71270.tsv" # Replace with the name of your data file
                                )) %>% 
  tibble::column_to_rownames("Gene") # Store gene names as the rownames for now
```

Let's ensure that the metadata and data are in the same sample order. 

```{r}
# Make the data in the order of the metadata
df <- df %>% dplyr::select(metadata$geo_accession)

# Check if this is in the same order
all.equal(colnames(df), metadata$geo_accession)
```

## 3) Set up design matrix
limma needs a numeric design matrix to signify which are treatment and control
samples. 
Here we are using the treatments supplied in the metadata to create
a design matrix where the "none" samples are assigned `0` and the "amputated"
samples are assigned `1`.
Note that the metadata variables that signify the treatment groups might be
different in across datasets and might not always be underneath the "treatment"
category.

```{r Set up design matrix}
# Create the design matrix from the genotype information
des.mat <- model.matrix(~metadata$`genotype/variation`)
```

## 4) Apply linear model
After applying our data to linear model, in this example we apply empirical Bayes
smoothing and Benjamini-Hochberg multiple testing correction. 
The `topTable` function default is to use Benjamini Hochberg but this can be
changed to a different method using the `adjust.method` argument.

```{r Apply linear model}
# Apply linear model to data
fit <- lmFit(df, design = des.mat)

# Apply empirical Bayes to smooth standard errors
fit <- eBayes(fit)

# Apply multiple testing correction and obtain stats
stats <- topTable(fit, number = nrow(df)) %>% 
  tibble::rownames_to_column("Gene")
```

## 5) Explore fitness of model
Here we will use two different plots that can be used to assess the quality of
your model. A guide to the interpretation of these plots and other statistics for 
gene expression data can be found [here](http://www.nathalievialaneix.eu/doc/pdf/tutorial-rnaseq.pdf).

```{r  Explore model, warning=FALSE}
# Create Q-Q plot
qq.plot <- qqt(fit$t, pch = 16, cex = 0.2); abline(0,1)

# Save plot to png
png(file.path("plots", # Replace with path to your output plots directory
              "qqplot_GSE71270.png" # Replace file name with a relevant output plot name
              ))
qqt(fit$t, pch = 16, cex = 0.2); abline(0,1)
dev.off()
```

Make a volcano plot and save to png

```{r}
# Create volcano plot 
voc.plot <- volcanoplot(fit, main = "Volcano Plot")

# Save plot to png
png(file.path("plots", # Replace with path to your output plots directory
              "volcano_plot_GSE71270.png" # Replace with a relevant output plot name
              ))
volcanoplot(fit, main = "Volcano Plot")
dev.off()
```

## 6) Write statistics to output results file

```{r  Write results}
readr::write_tsv(stats, file.path("results", # Replace with path to your output results directory
                                  "GSE71270_limma_results.tsv" # Replace with a relevant output name
                                  ))
```

Print session info:

```{r}
# Print session info 
sessionInfo()
```
