---
title: "Differential Expression Analysis"
author: "ALSF CCDL - Candace Savonen"
output:   
  html_notebook: 
    toc: true
    toc_float: true
---

*Purpose*: This notebook takes data and metadata from refine.bio and identifies 
differentially expressed genes. 
This script is very generally applicable to pre-processed RNA-Seq or
microarray data.

## 1) Install libraries
This script uses the bioconductor R package limma to identify differentially 
expressed genes.  
The full guide on [limma](https://bioconductor.org/packages/release/bioc/vignettes/limma/inst/doc/usersguide.pdf) 
shows examples of limma functions. 
<i>Citation</i>: Ritchie ME, Phipson B, Wu D, Hu Y, Law CW, Shi W, Smyth GK (2015). 
“limma powers differential expression analyses for RNA-sequencing and microarray
studies.” Nucleic Acids Research, 43(7), e47. 

```{r Install limma}
if (!("limma" %in% installed.packages())) {
  # Install ComplexHeatmap
  BiocManager::install("limma", update = FALSE)
}
```

Attach the `limma` library:

```{r}
# Magrittr pipe
`%>%` <- dplyr::`%>%`

# Attach library
library(limma)
```

Create output folders.

```{r}
# Create the results folder if it doesn't exist
if (!dir.exists("results")) {
  dir.create("results")
}
# Create the plots folder if it doesn't exist
if (!dir.exists("plots")) {
  dir.create("plots")
}
```

## 2) Import and set up data
Data downloaded from refine.bio include a metadata tab separated values ("tsv")
file and a data tsv file. This chunk of code will read the both tsv files and 
add them as data.frames to your environment. 

```{r Import data from .tsv files}
# Read in metadata tsv file
metadata <- read.delim(file.path("data", "metadata_GSE71270.tsv"),
                       header = TRUE)

# Read in data tsv file
df <- read.delim(file.path("data", "GSE71270.tsv"), header = TRUE,
                 row.names = 1, stringsAsFactors = FALSE)
```

## 3) Set up design matrix
limma needs a numeric design matrix to signify which are treatment and control
samples. 
Here we are using the treatments supplied in the metadata to create
a design matrix where the "none" samples are assigned `0` and the "amputated"
samples are assigned `1`.
Note that the metadata variables that signify the treatment groups might be
different in across datasets and might not always be underneath the "treatment"
category.

```{r Set up design matrix}
# Check if the samples are in the same order in the metadata and data files
# Have to use gsub to get rid of problematic punctuation and space so they are 
# matching
tmp <- match(gsub("X|\\.", "", colnames(df)), metadata$geo_accession)

# Use the indices identified in the line above to rearrange the design matrix to
# be in the same order as the data
# Create the design matrix
des.mat <- model.matrix(~metadata$genotype.variation[tmp])
```

## 3) Apply linear model
After applying our data to linear model, in this example we apply empircal Bayes
smoothing and Benjamini-Hochberg multiple testing correction. 
The `topTable` function default is to use Benjamini Hochberg but this can be
changed to a different method using the `adjust.method` argument.

```{r Apply linear model}
# Apply linear model to data
fit <- lmFit(df, design = des.mat)

# Apply empirical Bayes to smooth standard errors
fit <- eBayes(fit)

# Apply multiple testing correction and obtain stats
stats <- topTable(fit, number = nrow(df)) %>% 
  tibble::rownames_to_column("Genes")
```

## 4) Explore fitness of model
Here we will use two different plots that can be used to assess the quality of
your model. A guide to the interpretation of these plots and other statistics for 
gene expression data can be found [here](http://www.nathalievialaneix.eu/doc/pdf/tutorial-rnaseq.pdf).

```{r  Explore model, warning=FALSE}
# Create Q-Q plot
qq.plot <- qqt(fit$t, pch = 16, cex = 0.2); abline(0,1)

# Save plot to png
png(file.path("plots", "qqplot_GSE71270.png"))
qqt(fit$t, pch = 16, cex = 0.2); abline(0,1)
dev.off()

# Print out plot here
qq.plot
```

Make a volcano plot and save to png

```{r}
# Create volcano plot 
voc.plot <- volcanoplot(fit, main = "Volcano Plot")

# Save plot to png
png(file.path("plots", "volcano_plot_GSE71270.png"))
voc.plot
dev.off()

# Print out the plot here
voc.plot
```

## 5) Write statistics to output results file

```{r  Write results}
readr::write_tsv(stats, file.path("results", "GSE71270_limma_results.tsv"))
```

Print session info:

```{r}
# Print session info 
sessionInfo()
```
